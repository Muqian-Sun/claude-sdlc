# /review — 阶段审查（每阶段退出前必须执行）

用法：`/review [文件路径]`

参数：$ARGUMENTS

---

## 核心原则

**Review 不是最后才做的事，而是每个阶段的退出门禁。**

错误越晚发现修复成本越高：需求阶段的错误到编码阶段修复成本 ×10，到部署阶段 ×100。
因此每个阶段结束时都必须执行该阶段的专项审查，确保产出物质量合格后才能推进。

---

## 执行逻辑

### 1. 自动识别当前阶段

读取 CLAUDE.md 中的 `current_phase`，根据阶段选择对应的审查清单。

### 2. 确定审查范围

- **如果指定了文件路径**：审查指定文件（仅适用于 P3+ 阶段）
- **如果未指定文件**：审查当前阶段的全部产出物

---

## P1 需求分析 — 需求审查

### 审查清单
- [ ] **完整性**：是否覆盖了用户提出的所有需求点
- [ ] **明确性**：每条需求是否有清晰的验收标准，无歧义表述
- [ ] **一致性**：需求之间是否存在矛盾或冲突
- [ ] **可行性**：每条需求在当前代码库/技术栈下是否可实现
- [ ] **范围边界**：功能范围是否明确，是否识别了不做的事项
- [ ] **影响分析**：受影响的文件和模块是否已识别完整
- [ ] **风险识别**：技术风险和业务风险是否已列出

### 输出格式
```
╔══════════════════════════════════════╗
║       P1 需求审查报告                ║
╚══════════════════════════════════════╝

📋 需求清单审查：
  ✅ / ❌ {逐项检查结果}

⚠️ 发现的问题：
  1. [严重程度] {问题描述} → {建议}

📊 结论：{通过 / 需补充后通过}
```

---

## P2 系统设计 — 设计审查

### 审查清单
- [ ] **架构合理性**：方案是否是当前场景下的合理选择，是否过度设计
- [ ] **一致性**：设计是否与现有代码库的架构风格一致
- [ ] **需求覆盖**：设计方案是否覆盖了 P1 中所有需求
- [ ] **接口设计**：API/函数接口是否清晰、参数是否合理
- [ ] **数据流**：数据的流入、处理、流出路径是否清晰
- [ ] **错误处理策略**：异常和边界情况的处理方案是否已考虑
- [ ] **技术选型依据**：选型理由是否充分，是否评估了替代方案
- [ ] **实现步骤**：步骤分解是否合理，依赖关系是否明确
- [ ] **可测试性**：设计是否便于编写测试

### 输出格式
```
╔══════════════════════════════════════╗
║       P2 设计审查报告                ║
╚══════════════════════════════════════╝

🏗️ 架构方案审查：
  ✅ / ❌ {逐项检查结果}

⚠️ 发现的问题：
  1. [严重程度] {问题描述} → {建议}

📊 结论：{通过 / 需修改后通过}
```

---

## P3 编码实现 — 代码审查

### 审查范围
- 审查 CLAUDE.md 中 `modified_files` 列表里的所有文件
- 如指定了文件路径，仅审查该文件

### 审查清单

#### 3.1 设计符合性
- [ ] 代码实现是否与 P2 设计方案一致
- [ ] 是否有偏离设计的地方（如有，是否合理且已记录）

#### 3.2 代码质量
- [ ] 命名清晰、符合语言约定
- [ ] 函数单一职责、长度合理（≤50 行）
- [ ] 嵌套层级合理（≤3 层）
- [ ] 无魔法数字/字符串
- [ ] 无冗余代码或注释掉的代码
- [ ] 导入语句已清理
- [ ] 错误处理完善
- [ ] 代码格式一致

#### 3.3 安全性
- [ ] 无 SQL 注入风险
- [ ] 无 XSS 风险
- [ ] 无命令注入风险
- [ ] 无目录遍历风险
- [ ] 无硬编码的敏感信息（密码、密钥、token）
- [ ] 输入验证充分

#### 3.4 可维护性
- [ ] 代码可读性好
- [ ] 复杂逻辑有注释说明
- [ ] 模块职责清晰
- [ ] 符合项目已有的代码风格

### 输出格式
```
╔══════════════════════════════════════╗
║       P3 代码审查报告                ║
╚══════════════════════════════════════╝

📄 审查文件：{文件路径}

1️⃣ 设计符合性：{✅ 一致 / ⚠️ 有偏离}
2️⃣ 代码质量：{✅ 通过 / ⚠️ 有问题}
3️⃣ 安全性：{✅ 通过 / 🚨 有风险}
4️⃣ 可维护性：{✅ 通过 / ⚠️ 有问题}

⚠️ 发现的问题：
  1. [严重程度] {问题描述} → {建议}

📊 结论：{通过 / 需修改后通过}
```

### 未通过处理
- 严重/高优先级问题 → 必须在当前阶段内修复，修复后重新 `/review`
- 中/低优先级问题 → 记录到 `todo_items`，可在后续迭代处理

---

## P4 测试验证 — 测试审查

### 审查清单

#### 4.1 测试覆盖度
- [ ] 所有新增/修改的公共函数都有对应测试
- [ ] 正常路径已覆盖
- [ ] 错误路径已覆盖
- [ ] 边界条件已覆盖（空值、极值、边界值）
- [ ] 关键路径覆盖率 ≥ 80%

#### 4.2 测试质量
- [ ] 遵循 AAA 模式（Arrange-Act-Assert）
- [ ] 测试命名清晰（"should X when Y" 格式）
- [ ] 每个测试只验证一个逻辑概念
- [ ] 测试之间相互独立，无顺序依赖
- [ ] Mock 使用合理（只 mock 外部依赖，不 mock 内部实现）

#### 4.3 测试结果
- [ ] 所有测试通过（零失败）
- [ ] 无被跳过(skip)的测试（除非有明确原因）
- [ ] 测试执行时间合理

#### 4.4 回归保护
- [ ] 修复 bug 时先写了能复现该 bug 的测试
- [ ] 修改代码后已有测试仍通过（无回归）

### 输出格式
```
╔══════════════════════════════════════╗
║       P4 测试审查报告                ║
╚══════════════════════════════════════╝

🧪 测试覆盖度：{✅ 达标 / ⚠️ 不足}
   覆盖率：{数据}
   缺失覆盖：{列表}

📝 测试质量：{✅ 通过 / ⚠️ 有问题}
   {逐项检查结果}

✅ 测试结果：{全部通过 / ❌ 有失败}
   通过：{n} / 失败：{n} / 跳过：{n}

⚠️ 发现的问题：
  1. [严重程度] {问题描述} → {建议}

📊 结论：{通过 / 需补充测试后通过}
```

### 未通过处理
- 覆盖率不足 → 补充测试，重新 `/review`
- 测试失败 → 修复代码或测试，重新 `/review`

---

## P5 集成审查 — 全局审查（最终关卡）

### 说明
P5 是部署前的最终审查，侧重于**跨文件/跨模块的全局视角**，检查单个阶段审查无法发现的系统级问题。

### 审查清单

#### 5.1 全局一致性
- [ ] 各模块间接口调用参数匹配
- [ ] 数据模型在各层（API → 业务逻辑 → 存储）间一致
- [ ] 错误处理策略在各模块间一致
- [ ] 命名风格在全项目范围内一致

#### 5.2 集成安全性
- [ ] 模块间数据传递是否有信任边界问题
- [ ] 权限检查是否在正确的层级执行
- [ ] 敏感信息是否在模块间安全传递

#### 5.3 性能全局视角
- [ ] 无 N+1 查询问题
- [ ] 无不必要的重复计算或重复 I/O
- [ ] 热路径（频繁执行的代码路径）性能是否可接受
- [ ] 内存使用是否合理

#### 5.4 变更完整性
- [ ] 所有 P1 需求均已实现（逐项对照）
- [ ] 所有 P2 设计均已落地
- [ ] 所有 P3 代码审查问题已修复
- [ ] 所有 P4 测试通过
- [ ] 无遗漏的 TODO/FIXME

### 输出格式
```
╔══════════════════════════════════════╗
║       P5 集成审查报告                ║
╚══════════════════════════════════════╝

🔗 全局一致性：{✅ 通过 / ⚠️ 有问题}
🔒 集成安全性：{✅ 通过 / 🚨 有风险}
⚡ 性能全局视角：{✅ 通过 / ⚠️ 有问题}
📋 变更完整性：{✅ 全部覆盖 / ❌ 有遗漏}

需求覆盖追溯：
  ✅ 需求1 → 文件A:L10, 测试X
  ✅ 需求2 → 文件B:L20, 测试Y
  ❌ 需求3 → 未实现

⚠️ 发现的问题：
  1. [严重程度] {问题描述} → {建议}

📊 结论：{通过可部署 / 需回退修复}
```

### 未通过处理
- 需求遗漏 → 回退到 P3 实现，然后 P4 补测试
- 集成问题 → 回退到 P3 修复
- 全部通过 → 推进到 P6 部署

---

## P6 部署交付 — 交付审查

### 审查清单
- [ ] Git commit message 符合 Conventional Commits 规范
- [ ] 提交粒度合理（每个 commit 一个逻辑变更）
- [ ] 无敏感信息被提交（.env、密钥、token）
- [ ] .gitignore 是否需要更新
- [ ] PR 描述完整（Summary、Changes、Test Plan）
- [ ] 文档是否需要更新（README、CHANGELOG 等）

### 输出格式
```
╔══════════════════════════════════════╗
║       P6 交付审查报告                ║
╚══════════════════════════════════════╝

📦 提交审查：{✅ 通过 / ⚠️ 有问题}
📝 文档审查：{✅ 已更新 / ⚠️ 需更新}

📊 结论：{可交付 / 需调整后交付}
```

---

## 审查与阶段推进的关系

**`/phase next` 会自动触发当前阶段的 `/review`。**

```
用户执行 /phase next
     ↓
自动执行当前阶段的 /review
     ↓
  审查通过？ ──── 是 ──→ 推进到下一阶段
     │
     否
     ↓
  列出未通过项，停留在当前阶段
  用户修复后重新 /phase next
```

用户也可以随时手动执行 `/review` 进行中间检查，不必等到阶段结束。
