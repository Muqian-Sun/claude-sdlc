# /phase — SDLC 阶段管理

用法：`/phase [next|back|status]`

参数：$ARGUMENTS

---

## 执行逻辑

根据参数执行以下操作：

### 无参数 或 `status`
1. 读取 CLAUDE.md 中的 `current_phase` 值
2. 输出当前阶段信息：
   - 阶段编号和名称
   - 该阶段允许的操作
   - 该阶段的退出条件（含审查要求）
   - 当前已完成的退出条件项
   - 该阶段的审查类型和审查清单
3. 提示用户可用的操作（next/back）

### `next` — 推进到下一阶段

**推进流程自动包含阶段审查：**

```
/phase next
     ↓
Step 1: 检查非审查类退出条件
     ↓
Step 2: 自动触发当前阶段的 /review
     ↓
Step 3: 审查通过？
  ├── 是 → 推进到下一阶段
  └── 否 → 列出问题，停留在当前阶段
```

详细步骤：

1. 读取当前阶段
2. 检查 `01-lifecycle-phases.md` 中定义的非审查类退出条件：
   - ✅ 已满足的条件
   - ❌ 未满足的条件
3. **如果非审查类退出条件未全部满足**：
   - 列出未满足项
   - 提供完成建议
   - 不进入审查环节
4. **如果非审查类退出条件已满足，执行阶段审查**：
   - 自动执行当前阶段对应的 `/review`（P1→需求审查，P2→设计审查，P3→代码审查，P4→测试审查，P5→集成审查，P6→交付审查）
   - 输出审查报告
5. **审查通过**：
   - 将 `current_phase` 更新为下一阶段
   - 更新 `phase_history` 记录（含审查结果摘要）
   - 更新 `last_updated` 时间戳
   - 输出新阶段的入口信息和活动指南
6. **审查未通过**：
   - 列出所有审查问题
   - 提供修复建议
   - 不推进阶段
   - 提示用户修复后重新执行 `/phase next`
   - 询问用户是否要强制推进（记录跳过的审查项）

### `back` — 回退到上一阶段
1. 读取当前阶段
2. 如果已是 P0/P1，提示无法继续回退
3. 要求提供回退原因
4. 更新 `current_phase` 为上一阶段
5. 更新 `phase_history` 记录（含回退原因）
6. 更新 `last_updated` 时间戳
7. 输出回退后的阶段信息
8. 注意：回退后上一阶段的审查状态重置，再次推进时需重新审查

---

## 阶段速查表

| 阶段 | 名称 | 核心活动 | 阶段审查 |
|------|------|---------|---------|
| P0 | 未开始 | 等待任务 | — |
| P1 | 需求分析 | 理解需求、分析代码库、识别范围 | 需求审查 |
| P2 | 系统设计 | 架构设计、技术选型、实现计划 | 设计审查 |
| P3 | 编码实现 | 编写代码、遵循规范 | 代码审查 |
| P4 | 测试验证 | 编写测试、执行测试、修复 bug | 测试审查 |
| P5 | 集成审查 | 跨模块全局审查、需求追溯 | 集成审查 |
| P6 | 部署交付 | Git 提交、创建 PR、文档更新 | 交付审查 |

---

## 重要提醒

- **每次 `/phase next` 都会先执行审查**，审查是推进的前置条件
- 用户可随时手动执行 `/review` 进行中间检查，不必等到 `/phase next`
- 更新 CLAUDE.md 中的 `current_phase` 后，工具使用限制会相应变化
- Hooks 会根据 CLAUDE.md 中的阶段值进行运行时拦截
- 如果用户强制跳过审查，在 `phase_history` 中记录跳过的审查项
