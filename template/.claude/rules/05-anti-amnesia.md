# 反遗忘机制

本文件说明 SDLC Enforcer 系统如何对抗 Claude Code 的上下文遗忘问题。

---

## 1. 遗忘风险说明

Claude Code 在长对话中会触发 **Context Compaction**（上下文压缩），此时：
- 早期对话内容被压缩或丢弃
- 已建立的规范意识可能丢失
- 项目状态信息可能丢失
- 架构决策的上下文可能丢失

**这是 Claude Code 的固有机制，无法避免，但可以通过多层防御来对抗。**

---

## 2. 五层防御机制

### 第一层：CLAUDE.md（自动加载）
- CLAUDE.md 在每次对话开始和 compaction 后都会被重新加载
- 包含完整的 SDLC 规范摘要和当前项目状态
- **这是最关键的防线**

### 第二层：.claude/rules/（自动加载）
- rules/ 目录下的所有 .md 文件自动加载
- 不受 compaction 影响
- 提供详细的规范定义

### 第三层：Hooks（运行时拦截）
- PreToolUse hooks 在每次工具调用前执行
- 即使 Claude 忘记了阶段限制，hooks 也会拦截违规操作
- **这是被动安全网**

### 第四层：Stop Hook（回复后审查）
- 每次回复后触发
- 提醒 Claude 检查是否遵循 SDLC 规范
- 及时发现偏离

### 第五层：用户命令
- `/status` 随时查看完整状态
- `/checkpoint` 手动保存状态快照
- `/phase` 确认和管理阶段

---

## 3. 快速自检流程

**每次回复前执行（30 秒内完成）：**

```
1. 我当前在哪个阶段？→ 检查 CLAUDE.md 的 current_phase
2. 我要执行什么操作？→ 列出即将使用的工具
3. 这些操作在当前阶段允许吗？→ 对照阶段允许列表
4. CLAUDE.md 状态是最新的吗？→ 如有变更需更新
```

---

## 4. 深度自检流程

**在以下场景触发：**
- 阶段转换时
- 检测到 compaction 后
- 用户执行 `/status` 时
- 感觉上下文不完整时

```
1. 重新阅读 CLAUDE.md "当前项目状态" 区域
2. 确认 current_phase 值
3. 确认 task_description 值
4. 回顾 modified_files 列表
5. 回顾 architecture_decisions 列表
6. 回顾 todo_items 列表
7. 检查 phase_history 是否完整
8. 如有异常，向用户报告并请求确认
```

---

## 5. 异常恢复流程

当检测到状态不一致或信息丢失时：

### 自动恢复
1. 重新读取 CLAUDE.md 获取最新状态
2. 重新读取 rules/ 目录下的规范文件
3. 根据 modified_files 列表读取已修改的文件以恢复上下文
4. 向用户报告恢复结果

### 请求用户协助
如果自动恢复信息不足：

```
⚠️ 检测到上下文信息可能不完整。

当前已恢复的信息：
- 阶段：{current_phase}
- 任务：{task_description}
- 已修改文件：{modified_files}

请确认以上信息是否正确，以及是否有遗漏的上下文？
```

---

## 6. 用户沟通模板

### Compaction 后恢复通知
```
🔄 检测到上下文压缩，已从 CLAUDE.md 恢复项目状态：

- 当前阶段：{阶段名称}
- 进行中的任务：{任务描述}
- 已修改 {n} 个文件
- 待办事项 {n} 项

确认以上信息正确后，我将继续工作。
```

### 阶段偏离警告
```
⚠️ 当前操作可能偏离 SDLC 规范：

- 当前阶段：{阶段名称}
- 尝试的操作：{操作描述}
- 该操作应在 {正确阶段} 阶段执行

是否要先完成当前阶段的退出条件后再推进？
```

---

## 7. 规范遵守优先级

当不同规则之间出现冲突时，按以下优先级处理：

1. **用户明确指令** — 最高优先级
2. **安全性要求** — 不可妥协
3. **SDLC 阶段流程** — 核心规范
4. **编码/测试标准** — 质量保障
5. **Git 工作流** — 流程规范

> 用户始终可以通过明确指令覆盖规范要求（例如："跳过 P2 直接开始编码"），但 Claude 应提醒用户跳过的风险。
