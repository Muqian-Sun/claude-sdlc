# 多 Agent 并行开发

本规则定义如何利用 Claude Code 的 Task 工具派发多个子 Agent 并行工作，提升开发效率。

---

## 核心原则

1. **独立性** — 只有彼此无依赖的任务才可并行
2. **原子性** — 每个子 Agent 负责一个完整的逻辑单元（一个模块/一个文件/一组相关测试）
3. **PRD 对齐** — 每个子 Agent 的任务必须明确对应 PRD 中的哪些需求
4. **主 Agent 协调** — 主 Agent 负责拆分任务、分配、汇总结果、解决冲突

---

## 适用阶段与并行策略

### P3 编码实现 — 并行编码

**触发条件**：P2 设计方案中有 2 个以上相互独立的实现步骤/模块。

**拆分原则**：
- 按 P2 设计的模块/文件粒度拆分
- 每个子 Agent 分配明确的文件列表和对应的 PRD 需求编号
- 共享依赖（如公共工具函数）由主 Agent 先完成，再派发并行任务

**执行流程**：
1. 主 Agent 分析 P2 设计，识别可并行的实现单元
2. 先完成共享基础代码（如有）
3. 用 Task 工具并行派发子 Agent，每个子 Agent 的 prompt 必须包含：
   - 对应的 PRD 需求编号（R1, R2...）
   - 设计方案摘要
   - 要创建/修改的文件路径
   - 编码规范要点（见 02-coding-standards.md）
4. 汇总所有子 Agent 结果
5. 主 Agent 检查模块间接口一致性，解决冲突
6. 更新 CLAUDE.md 的 modified_files

**子 Agent 类型**：`subagent_type: "sdlc-coder"`（使用 `.claude/agents/sdlc-coder.md` 自定义 Agent，内置 PRD 编码约束和工具限制）

### P4 测试验证 — 并行编写测试

**触发条件**：需要为 2 个以上独立模块编写测试。

**拆分原则**：
- 按被测模块拆分，每个子 Agent 负责一个模块的测试
- 每个子 Agent 需读取对应的源代码文件

**执行流程**：
1. 主 Agent 列出 PRD→测试映射表，确定每个模块的测试职责
2. 用 Task 工具并行派发子 Agent 编写测试，prompt 必须包含：
   - 对应的 PRD 需求编号
   - 被测源文件路径
   - 测试标准要点（见 03-testing-standards.md）
   - 测试文件命名和存放位置
3. 汇总所有测试文件
4. 主 Agent 统一执行全部测试（Bash），确认全部通过

**子 Agent 类型**：`subagent_type: "sdlc-tester"`（使用 `.claude/agents/sdlc-tester.md` 自定义 Agent，内置 AAA 模式和覆盖率约束）

### P5 集成审查 — 并行审查维度

**触发条件**：modified_files ≥ 5 个文件。

**拆分原则**：
- 按审查维度并行，而非按文件并行
- 最多 3 个并行审查 Agent

**审查维度分配**：
| Agent | 审查职责 |
|-------|---------|
| Agent A | 全局一致性 + 集成安全性（5.1 + 5.2） |
| Agent B | 性能全局视角 + 变更完整性（5.3 + 5.5） |
| Agent C | PRD 四环追溯（5.4）— 逐条 PRD 追溯 需求→设计→代码→测试 |

**执行流程**：
1. 主 Agent 准备审查上下文（PRD、设计方案、modified_files、测试文件列表）
2. 并行派发 3 个 Agent，每个 Agent 的 prompt 包含完整上下文 + 负责的审查维度
3. 汇总所有审查结果
4. 主 Agent 合并为 P5 集成审查报告

**子 Agent 类型**：`subagent_type: "sdlc-reviewer"`（使用 `.claude/agents/sdlc-reviewer.md` 自定义 Agent，内置四环追溯和安全审查约束）

---

## 不适用并行的场景

以下场景**禁止并行**，必须串行执行：
- P1 需求分析 — 需要与用户交互，不可并行
- P2 系统设计 — 设计方案需要全局一致性，不可拆分
- P6 部署交付 — git 操作必须串行
- 模块间有数据依赖 — A 的输出是 B 的输入
- 修改同一个文件 — 会产生冲突

---

## 子 Agent Prompt 模板

### P3 编码子 Agent

```
你是一个编码子 Agent，负责实现以下模块：

## 任务
- PRD 需求：{Rn: 需求描述}
- 设计方案：{该模块的设计摘要}
- 目标文件：{文件路径列表}

## 规范
- 严格按 PRD 需求实现，不添加额外功能
- 命名规范：{语言对应的命名约定}
- 函数不超过 50 行，嵌套不超过 3 层
- 错误处理完善
- 无硬编码敏感信息

## 输出
完成编码后，报告：已创建/修改的文件列表 + 关键实现决策。
```

### P4 测试子 Agent

```
你是一个测试子 Agent，负责为以下模块编写测试：

## 任务
- PRD 需求：{Rn: 需求描述 + 验收标准}
- 被测文件：{源文件路径}
- 测试文件：{测试文件路径}

## 规范
- 遵循 AAA 模式（Arrange-Act-Assert）
- 命名格式："should X when Y"
- 覆盖正常路径、错误路径、边界条件
- 只 mock 外部依赖
- 每个 PRD 需求至少一个测试用例

## 输出
完成后报告：测试文件路径 + 测试用例清单 + PRD→测试映射。
```

### P5 审查子 Agent

```
你是一个审查子 Agent，负责以下审查维度：

## 审查范围
{Agent 对应的审查维度描述}

## 上下文
- PRD：{完整 PRD}
- 设计方案：{设计摘要}
- 修改文件：{modified_files 列表}
- 测试文件：{测试文件列表}

## 输出格式
每个检查项输出 ✅/❌/⚠️ + 具体描述。
发现问题时标注 [严重程度] + 建议。
```

---

## 并行度控制

- P3 编码：最多 **2 个**并行子 Agent
- P4 测试：最多 **2 个**并行子 Agent
- P5 审查：最多 **2 个**并行子 Agent（按维度合并）
- 总原则：子 Agent 数量 ≤ 可独立拆分的任务数量，不为并行而强行拆分

---

## 上下文保护策略（重要）

子 Agent 共享主会话的上下文窗口。上下文不足时子 Agent 会失败，且可能导致主会话不可用。

### 何时使用并行 Agent
- **使用**：PRD 有 3+ 条独立需求，且当前对话较短（刚开始或刚 compaction 后）
- **不使用**：长对话中、上下文已较满、只有 1-2 个模块、模块间有依赖

### 保护规则
1. **优先串行** — 如果不确定上下文是否充足，用主 Agent 串行完成，不要冒险并行
2. **小任务不并行** — 单个文件或 <50 行代码的任务直接在主 Agent 中完成
3. **控制 prompt 长度** — 子 Agent 的 prompt 应精简，只包含该模块需要的 PRD 条目和设计摘要，不要复制完整 PRD
4. **一轮只派 2 个** — 最多同时派发 2 个子 Agent，等返回后再派下一批
5. **子 Agent 失败时回退** — 如果子 Agent 因上下文不足失败，不要重试，改为主 Agent 串行完成该任务
6. **长对话中禁止并行** — 如果当前对话已经很长（多轮交互后），所有工作改为串行
