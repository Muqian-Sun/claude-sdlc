# 多 Agent 并行开发

利用 Task 工具派发子 Agent 并行工作，提升 P3/P4/P5 效率。

---

## 核心原则

1. **独立性** — 只有无依赖的任务才可并行
2. **原子性** — 每个子 Agent 负责一个完整逻辑单元
3. **PRD 对齐** — 每个子 Agent 任务对应明确的 PRD 需求
4. **主 Agent 协调** — 拆分、分配、汇总、解决冲突

子 Agent 使用 `.claude/agents/` 中的自定义 Agent 定义（sdlc-coder/sdlc-tester/sdlc-reviewer），已内置角色约束和工具限制。

---

## 通用执行流程

1. 主 Agent 分析可并行的独立单元（P3 按模块、P4 按被测模块、P5 按审查维度）
2. 先完成共享基础代码/上下文准备（如有）
3. 用 Task 工具并行派发子 Agent，prompt 包含：PRD 需求编号 + 相关设计/代码 + 目标文件 + 规范要点
4. 汇总结果 → 检查一致性 → 解决冲突
5. 更新 modified_files

### 阶段差异

| 阶段 | 触发条件 | 子 Agent | 拆分粒度 | 汇总后操作 |
|------|---------|---------|---------|-----------|
| P3 | 2+ 独立实现模块 | sdlc-coder | 按模块/文件 | 检查接口一致性 |
| P4 | 2+ 独立被测模块 | sdlc-tester | 按被测模块 | 统一执行全部测试 |
| P5 | modified_files ≥5 | sdlc-reviewer | 按审查维度（最多3个） | 合并审查报告 |

---

## 不适用并行的场景

- P1/P2/P6 — 需交互/全局一致/串行操作
- 模块间有数据依赖 / 修改同一文件

---

## 并行度与上下文保护

- 最多 **2 个**并行子 Agent（一轮）
- **小任务不并行** — 单文件或 <50 行直接主 Agent 完成
- **长对话中禁止并行** — 上下文不足时改串行
- 子 Agent 失败 → 不重试，改主 Agent 串行完成
- prompt 精简 — 只含该模块需要的 PRD 条目和设计摘要
