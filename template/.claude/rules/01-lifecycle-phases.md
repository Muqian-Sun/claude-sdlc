# SDLC 六阶段详细定义

本规则定义软件开发生命周期（SDLC）六个阶段的详细要求。**所有阶段必须顺序执行，禁止跳过。**

**核心原则：**
1. **每个阶段都有对应的审查（Review）**，审查通过是阶段推进的必要条件。
2. **严格按 PRD 开发**：P1 产出经用户确认的 PRD，P2-P6 以 PRD 为唯一依据，不得自行增减。

---

## P1 — 需求分析

### 入口条件
- 用户提出了明确的开发任务或需求

### 阶段活动
- 理解用户需求，**逐条澄清**，消除模糊点
- 分析现有代码库（Read, Glob, Grep）
- 识别技术约束和依赖关系
- **明确划定范围边界** — 做什么、不做什么
- 搜索相关文档和最佳实践（WebSearch, WebFetch）
- **整理出编号化的 PRD 需求清单，提交给用户确认**

### 必需产出物
- [ ] **PRD（需求清单）**— 格式要求：
  - 每条需求有唯一编号（R1, R2, R3...）
  - 每条需求有明确的验收标准
  - 明确列出"不做"的事项（范围排除项）
  - 需求分类：功能需求 / 非功能需求
- [ ] 技术可行性评估
- [ ] 影响范围分析（受影响的文件和模块）
- [ ] 风险识别

### PRD 确认流程
1. Claude 整理 PRD 初稿后，**必须向用户展示完整的需求清单**
2. 用户确认后，将 PRD 写入 .claude/project-state.md 的 `prd` 字段
3. **PRD 一旦写入即锁定**，后续阶段以此为唯一依据
4. 如需修改 PRD，必须回到 P1 重新获得用户确认

### 阶段审查（需求审查）
推进前必须通过 `/review` 需求审查：
- [ ] 需求完整性 — 覆盖用户提出的所有需求点，无遗漏
- [ ] 需求明确性 — 每条需求有编号、有验收标准、无歧义
- [ ] 需求一致性 — 需求间无矛盾
- [ ] 范围边界 — 明确列出不做的事项
- [ ] 技术可行性 — 在当前技术栈下可实现
- [ ] 影响分析 — 受影响的文件和模块已识别
- [ ] **用户已确认** — PRD 经用户明确确认
- [ ] **PRD 已写入 .claude/project-state.md** — `prd` 字段已填写

### 退出条件
- PRD 已整理完成并经用户确认
- PRD 已写入 .claude/project-state.md 的 `prd` 字段
- 影响范围已明确
- **需求审查已通过**（`/review`）

### 阶段推进方式
**需用户确认** — 用户确认 PRD 后，自动执行需求审查，通过后自动进入 P2。

### 允许的工具
- ✅ Read, Glob, Grep（代码分析）
- ✅ WebSearch, WebFetch（资料查询）
- ❌ Write, Edit（禁止修改代码文件）
- ❌ Bash 测试命令（禁止执行测试）

---

## P2 — 系统设计

### 入口条件
- P1 需求分析已完成（含需求审查通过）
- PRD 已获用户确认并写入 .claude/project-state.md

### 阶段活动
- **【最新技术与设计调研 — 必须首先执行】**：
  1. 用 Context7 MCP (`resolve-library-id` → `query-docs`) 查询涉及的库/框架的**最新官方文档**，了解当前推荐的架构模式、最新 API 和最佳实践
  2. 用 WebSearch 搜索当前**最流行的架构设计方案**和社区最佳实践
  3. **UI/UX 调研**：用 WebSearch 搜索**最新 UI/UX 设计趋势**、流行的交互模式和视觉风格（如 "latest UI design trends [年份]"、"best [框架] UI components"），了解当前主流设计规范
  4. 将调研结果纳入设计决策依据，记录到 `architecture_decisions`
- 逐条对照 PRD，设计系统架构方案
- 确定技术选型（**基于最新文档和社区趋势，而非过时记忆**）
- **原型设计**（如涉及 UI）：
  - 设计页面布局和组件结构
  - 定义交互流程（用户操作路径）
  - 确定视觉风格（配色、字体、间距规范）
  - 描述响应式适配方案
- 设计数据模型和接口
- 制定文件/模块修改计划
- 评估多种实现方案的优劣
- **为每条 PRD 需求标注对应的设计模块**

### 必需产出物
- [ ] **技术调研记录**（查阅了哪些库的最新文档、采用了什么最新实践）
- [ ] 架构设计方案（含理由说明，**引用最新文档作为依据**）
- [ ] **原型设计**（如涉及 UI）— 页面布局、组件结构、交互流程、视觉风格规范
- [ ] **PRD→设计映射表**（每条需求对应的设计模块/文件）
- [ ] 文件修改清单（预计新增/修改/删除的文件）
- [ ] 接口设计（如涉及 API）
- [ ] 实现步骤分解

### 阶段审查（设计审查）
推进前必须通过 `/review` 设计审查：
- [ ] **最新文档已查阅** — 涉及的库/框架已通过 Context7 查询最新文档，未使用过时 API 或已废弃模式
- [ ] **UI/UX 调研已完成**（如涉及 UI）— 已搜索最新 UI/UX 设计趋势和流行交互模式，原型设计反映了当前主流设计规范
- [ ] **PRD 全覆盖** — 设计方案覆盖 PRD 中的每一条需求（逐条对照，不可遗漏）
- [ ] **无超出 PRD 的设计** — 不包含 PRD 未要求的功能模块或接口
- [ ] 架构合理性 — 方案合理，无过度设计，**符合当前社区最佳实践**
- [ ] 与现有架构一致性 — 符合项目已有风格
- [ ] **原型设计完整**（如涉及 UI）— 页面布局、组件结构、交互流程、视觉风格已定义
- [ ] 接口设计 — API/函数接口清晰、参数合理
- [ ] 错误处理策略 — 异常和边界情况已考虑
- [ ] 技术选型依据 — 有充分理由，评估了替代方案，**引用了最新文档**
- [ ] 可测试性 — 设计便于编写测试

### 退出条件
- 架构方案已获用户确认
- PRD→设计映射表已完成（无遗漏、无多余）
- 实现步骤已明确
- 技术选型已确定
- **设计审查已通过**（`/review`）

### 阶段推进方式
**需用户确认** — 用户确认设计方案后，自动执行设计审查，通过后自动进入 P3 并**启动自动驱动模式**（P3→P6 全自动完成）。

### 允许的工具
- ✅ Read, Glob, Grep（代码分析）
- ✅ WebSearch, WebFetch（技术调研）
- ✅ Context7 MCP（查询最新官方文档）
- ✅ Chrome（UI/UX 调研、竞品分析）
- ❌ Write, Edit（禁止修改代码文件）
- ❌ Bash 测试命令（禁止执行测试）

---

## P3 — 编码实现

### 入口条件
- P2 系统设计已完成（含设计审查通过）
- 架构方案已获用户确认
- 实现步骤已明确

### 阶段活动
- **【最新 API 查阅 — 编码前必须执行】**：
  1. 用 Context7 MCP 查询所用库/框架的**最新 API 文档和代码示例**，确认当前推荐的写法
  2. 用 WebSearch 搜索**最新的实现模式和最佳实践**（如 "how to [具体功能] with [库名] latest"）
  3. 确保使用当前推荐的 API，不使用已废弃（deprecated）的方法或过时写法
- **严格按 P2 设计方案编写代码，不添加 PRD 之外的功能**
- 遵循编码规范（见 02-coding-standards.md）
- 每完成一个逻辑单元，更新 .claude/project-state.md 中的 modified_files
- 记录实现中的关键决策
- **如发现 PRD 有遗漏或设计需调整，停止编码，回退到 P1/P2 与用户确认**
- **多 Agent 并行编码**（如有独立模块）：按设计方案拆分独立模块，用 Task 工具并行派发子 Agent 编码（见 07-parallel-agents.md）

### 禁止行为
- ❌ 实现 PRD 未列出的功能
- ❌ 添加"顺手"的优化、重构、额外参数、额外配置项
- ❌ 跳过 PRD 中任何一条需求
- ❌ 以"更好的方案"自行替换用户已确认的需求

### 必需产出物
- [ ] 功能代码实现（**仅限 PRD 范围**）
- [ ] 代码符合编码规范
- [ ] .claude/project-state.md 中 modified_files 已更新
- [ ] 关键实现决策已记录

### 阶段审查（代码审查）
推进前必须通过 `/review` 代码审查：
- [ ] **最新 API 使用** — 代码使用的 API/方法是否为当前版本推荐写法，无已废弃的调用
- [ ] **PRD 符合性** — 逐条对照 PRD，每条需求都已实现，无遗漏
- [ ] **无 PRD 外代码** — 不存在 PRD 未要求的功能、接口、配置、优化
- [ ] **Lint 通过** — lint 工具 0 error
- [ ] **类型检查通过**（如适用）— typecheck 0 error
- [ ] **构建成功** — build 命令无报错
- [ ] **依赖安全** — 无 high/critical 漏洞
- [ ] 设计符合性 — 实现与 P2 设计方案一致
- [ ] 代码质量 — 命名、函数设计、格式规范
- [ ] 安全性 — 无注入、XSS、敏感信息泄露等风险
- [ ] 可维护性 — 可读、有必要注释、模块职责清晰

### 退出条件
- PRD 中所有需求均已实现
- 无 PRD 范围外的代码
- 代码通过基本语法检查
- 无明显的编码规范违规
- **代码审查已通过**（`/review`）

### 阶段推进方式
**自动驱动** — 编码完成后自动执行代码审查。审查通过 → 自动进入 P4。审查未通过 → 自动修复并重试（最多 3 次）。

### 允许的工具
- ✅ Read, Glob, Grep（代码分析）
- ✅ Write, Edit（代码编写）
- ✅ Bash（编译/构建/lint，但不执行测试）
- ✅ Bash（lint/typecheck/build/audit 审查工具）
- ✅ Context7 MCP（查询最新 API 文档和代码示例）
- ✅ WebSearch, WebFetch（查询最新实现模式）
- ❌ Bash 测试命令（禁止执行测试）

---

## P4 — 测试验证

### 入口条件
- P3 编码实现已完成（含代码审查通过）
- 所有 PRD 需求均已编码

### 阶段活动
- **按 PRD 需求编写测试** — 每条需求至少对应一个测试用例
- 执行测试并分析结果
- 修复发现的 bug（仅限 PRD 范围内的 bug）
- 确保测试覆盖率达标
- **多 Agent 并行编写测试**（如有独立模块）：按模块拆分，用 Task 工具并行派发子 Agent 编写测试（见 07-parallel-agents.md）

### 必需产出物
- [ ] 测试用例代码（**对应 PRD 需求**）
- [ ] **PRD→测试映射表**（每条需求对应哪些测试）
- [ ] 测试执行结果（全部通过）
- [ ] Bug 修复记录（如有）
- [ ] 测试覆盖率报告（如工具支持）

### 阶段审查（测试审查）
推进前必须通过 `/review` 测试审查：
- [ ] **PRD 需求全覆盖** — 每条 PRD 需求都有对应测试验证
- [ ] **测试全部通过** — 真实执行测试，0 failure
- [ ] **覆盖率达标** — 行覆盖率 ≥80%、关键业务逻辑 ≥90%、分支 ≥70%（来自工具输出，非估算）
- [ ] 测试覆盖度 — 新增/修改的公共函数均有测试，正常/错误/边界路径已覆盖
- [ ] 测试质量 — 遵循 AAA 模式，命名清晰，测试独立
- [ ] 测试结果 — 全部通过，无跳过
- [ ] 回归保护 — 已有测试仍通过

### 退出条件
- PRD 中每条需求都有对应测试
- 所有测试用例通过
- 关键业务逻辑覆盖率 ≥ 90%
- 无已知未修复的 bug
- **测试审查已通过**（`/review`）

### 阶段推进方式
**自动驱动** — 测试全部通过后自动执行测试审查。审查通过 → 自动进入 P5。审查未通过 → 自动补充测试/修复并重试（最多 3 次）。

### 允许的工具
- ✅ Read, Glob, Grep（代码分析）
- ✅ Write, Edit（编写测试 / 修复 bug）
- ✅ Bash（执行测试、构建、lint）
- ✅ Chrome（视觉测试、E2E 验证）

---

## P5 — 集成审查

### 入口条件
- P4 测试验证已完成（含测试审查通过）
- 所有测试通过

### 阶段活动
- 跨模块全局一致性检查
- 集成安全性审查
- 性能全局视角检查
- 需求→设计→代码→测试的完整性追溯
- 记录审查发现

### 说明
P5 不再是唯一的 review 阶段。P1-P4 的阶段审查已在各阶段内完成，P5 侧重于**跨文件/跨模块的全局视角**，检查单个阶段审查无法发现的系统级问题。

### 必需产出物
- [ ] 集成审查报告（全局一致性、集成安全、性能、变更完整性）
- [ ] **PRD 完整追溯表**（每条 PRD 需求 → 对应设计 → 对应代码文件:行号 → 对应测试）
- [ ] 问题修复确认（如有需修复项，回退到 P3/P4）

### 阶段审查（集成审查）
推进前必须通过 `/review` 集成审查：
- [ ] **PRD 完整追溯** — 逐条 PRD 需求追溯：需求→设计→代码→测试，四环无断链
- [ ] **无 PRD 外变更** — 不存在任何 PRD 未要求的功能代码
- [ ] 全局一致性 — 模块间接口、数据模型、错误处理策略一致
- [ ] 集成安全性 — 信任边界、权限检查、敏感信息传递安全
- [ ] 性能全局视角 — 无 N+1、无重复 I/O、热路径可接受
- [ ] 无遗漏 TODO/FIXME

### 退出条件
- 集成审查报告已生成
- PRD 完整追溯表已生成（每条需求四环完整）
- 无 PRD 外变更
- 所有严重/高优先级问题已修复
- **集成审查已通过**（`/review`）

### 阶段推进方式
**自动驱动** — 集成审查通过 → 自动进入 P6。发现问题 → 自动回退到 P3/P4 修复后重新推进（最多 3 次）。

### 允许的工具
- ✅ Read, Glob, Grep（代码审查）
- ⚠️ Write, Edit（仅在修复审查问题时允许，修复后需重回 P4 验证）

---

## P6 — 部署交付

### 入口条件
- P5 集成审查已通过
- 所有审查问题已解决

### 阶段活动
- 执行 git 操作（add, commit, push）
- 创建 PR（如需要）
- 更新文档（如需要）
- 清理临时文件

### 必需产出物
- [ ] Git commit（符合 Conventional Commits 规范）
- [ ] PR（如适用）
- [ ] 更新后的文档（如适用）

### 阶段审查（交付审查）
交付前必须通过 `/review` 交付审查：
- [ ] Commit 规范 — 符合 Conventional Commits，粒度合理
- [ ] 无敏感信息 — 无 .env、密钥、token 被提交
- [ ] PR 描述 — Summary/Changes/Test Plan 完整
- [ ] 文档更新 — README/CHANGELOG 按需更新

### 退出条件
- 代码已提交
- PR 已创建（如适用）
- **交付审查已通过**（`/review`）

### 阶段推进方式
**自动完成** — 交付审查通过后，向用户输出交付摘要报告（PRD 完成情况、修改文件、测试结果、Git 提交信息），任务结束。

### 允许的工具
- ✅ Read, Glob, Grep
- ✅ Bash（git 操作、部署命令）
- ⚠️ Write, Edit（仅用于文档更新）

---

## 审查总览

**每个阶段的审查都包含 PRD 符合性检查。**

| 阶段 | 审查类型 | PRD 检查重点 | 其他审查重点 | 未通过处理 |
|------|---------|-------------|-------------|-----------|
| P1 | 需求审查 | PRD 完整性、明确性、用户已确认 | 可行性、影响分析 | 补充后重新审查 |
| P2 | 设计审查 | PRD 全覆盖、无超出 PRD 的设计 | **最新文档已查阅**、架构合理性、可测试性 | 修改后重新审查 |
| P3 | 代码审查 | PRD 全实现、无 PRD 外代码 | **最新 API 使用**、代码质量、安全性 | 修改后重新审查 |
| P4 | 测试审查 | 每条 PRD 需求有对应测试 | 覆盖度、测试质量 | 补充后重新审查 |
| P5 | 集成审查 | PRD→设计→代码→测试四环追溯 | 全局一致性、安全 | 回退修复后重新审查 |
| P6 | 交付审查 | 交付物与 PRD 一致 | Commit 规范、文档 | 修正后重新审查 |
