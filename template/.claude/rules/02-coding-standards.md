# 通用编码规范

本规范适用于所有在 P3（编码实现）阶段编写的代码。

---

## 0. PRD 约束（最高优先级）

**编码阶段的一切活动必须严格服务于 PRD，不得超出 PRD 范围。**

- 每写一个函数/类/模块时，必须能回答"这对应 PRD 中的哪条需求？"
- **禁止添加**：不得实现 PRD 未列出的功能、接口、参数、配置项、错误处理分支、优化
- **禁止减少**：不得跳过或简化 PRD 中任何一条需求
- **禁止"顺手"改进**：不得借编码之机重构无关代码、添加额外文档、优化未要求的性能

> 如果编码过程中发现 PRD 有遗漏或需调整，**停止编码，回退到 P1 与用户确认修改后的 PRD**。

---

## 1. 命名规范

### 通用原则
- 使用有意义的、描述性的名称
- 避免单字母变量名（循环计数器 i/j/k 除外）
- 避免缩写，除非是广泛认知的缩写（如 URL, HTTP, ID）
- 名称应表达"是什么"或"做什么"，而非"怎么做"

### 语言特定约定
- **JavaScript/TypeScript**: camelCase 变量/函数，PascalCase 类/组件，UPPER_SNAKE_CASE 常量
- **Python**: snake_case 变量/函数，PascalCase 类，UPPER_SNAKE_CASE 常量
- **Go**: camelCase 私有，PascalCase 导出，缩写全大写（如 HTTPServer）
- **其他语言**: 遵循该语言社区的主流约定

### 布尔值命名
- 使用 is/has/can/should 前缀：`isActive`, `hasPermission`, `canEdit`

---

## 2. 函数设计

### 单一职责
- 每个函数只做一件事
- 函数名应能准确描述其功能
- 如果函数名需要用 "and" 连接，考虑拆分

### 参数规范
- 参数数量不超过 4 个，超过时使用对象/结构体参数
- 避免布尔参数（flag argument），改用语义明确的枚举或独立函数
- 参数顺序：必需参数在前，可选参数在后

### 函数体规范
- 函数体不超过 50 行（不含注释和空行）
- 提前返回（early return），减少嵌套层级
- 嵌套层级不超过 3 层

---

## 3. 代码结构

### 文件组织
- 每个文件有明确的单一主题
- 相关功能放在相近位置
- 导入/引用语句按规范排序（标准库 → 第三方 → 本地）

### 注释规范
- 注释解释"为什么"，而非"是什么"
- 避免注释掉的代码（应删除，用 git 历史查看）
- 公共 API 需要文档注释
- 复杂算法需要说明注释

### 代码格式
- 遵循项目已有的格式化配置
- 如无配置，使用语言社区的标准格式化工具（如 Prettier, Black, gofmt）
- 一致的缩进（项目内统一为 tab 或空格）

---

## 4. 错误处理

### 原则
- 不要吞掉错误（silent catch）
- 错误信息应有足够上下文，便于定位问题
- 区分可恢复错误和不可恢复错误

### 实践
- 优先使用语言原生的错误处理机制
- 自定义错误类型应继承标准错误类
- 记录错误时包含：发生位置、输入参数、错误原因
- 对外暴露的接口不要泄露内部实现细节

---

## 5. 安全规范

### 输入验证
- 所有外部输入必须验证和清理
- 使用参数化查询防止 SQL 注入
- 对用户输入进行 HTML 转义防止 XSS
- 文件路径操作需防止目录遍历攻击

### 敏感信息
- 禁止硬编码密码、密钥、token
- 使用环境变量或安全的密钥管理方案
- 日志中不记录敏感信息

### 依赖安全
- 使用可信来源的依赖包
- 注意依赖包的已知漏洞
- 最小化依赖范围

---

## 6. 代码质量检查清单

在 P3 阶段完成编码后，对每个修改的文件执行以下检查：

- [ ] **PRD 符合性** — 该文件的所有代码都能对应到 PRD 中的某条需求
- [ ] 命名是否清晰、符合约定
- [ ] 函数是否单一职责、长度合理
- [ ] 错误处理是否完善
- [ ] 无硬编码的魔法数字/字符串
- [ ] 无安全隐患（注入、XSS、敏感信息泄露）
- [ ] 代码格式一致
- [ ] 无冗余的注释或被注释掉的代码
- [ ] 导入语句已清理（无未使用的导入）
