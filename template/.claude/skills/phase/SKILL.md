---
name: phase
description: "SDLC 阶段管理命令。查看当前阶段、推进到下一阶段、或回退。用户说'下一阶段'/'推进'/'查看阶段'时自动触发。"
argument-hint: "[next|back|status]"
allowed-tools:
  - Read
  - Edit
  - Glob
  - Grep
---

用法：`/phase [next|back|status]`

参数：$ARGUMENTS

---

## 当前阶段

!`sed -n 's/^current_phase:[[:space:]]*\([^[:space:]#]*\).*/当前阶段: \1/p' "${CLAUDE_PROJECT_DIR}"/.claude/project-state.md 2>/dev/null || echo "当前阶段: P0"`

## 执行逻辑

根据参数执行以下操作：

### 无参数 或 `status`
1. 读取 .claude/project-state.md 中的 `current_phase` 值
2. 输出当前阶段信息：
   - 阶段编号和名称
   - 该阶段允许的操作
   - 该阶段的退出条件（含审查要求）
   - 当前已完成的退出条件项
   - 该阶段的审查类型和审查清单
   - 阶段推进方式（需用户确认 / 自动驱动）
3. 提示用户可用的操作（next/back）

### `next` — 推进到下一阶段

**推进流程（含自动驱动判断）：**

```
/phase next
     ↓
Step 1: 检查非审查类退出条件
     ↓
Step 2: 自动触发当前阶段的 /review
     ↓
Step 3: 审查通过？
  ├── 是 → 推进到下一阶段
  │         ├── P3/P4/P5 → 自动驱动：立即开始下一阶段工作
  │         └── P6 → 完成交付，输出交付摘要
  └── 否 → 自动修复（P3-P6）或向用户报告（P1-P2）
```

详细步骤：

1. 读取当前阶段
2. 检查 `01-lifecycle-phases.md` 中定义的非审查类退出条件：
   - ✅ 已满足的条件
   - ❌ 未满足的条件
3. **如果非审查类退出条件未全部满足**：
   - P1/P2：列出未满足项，提供完成建议
   - P3-P6（自动驱动）：自动完成缺失项，然后重新检查
4. **执行阶段审查**：
   - 自动执行当前阶段对应的 `/review`
   - 输出审查报告
5. **审查通过**：
   - 将 .claude/project-state.md 的 `current_phase` 更新为下一阶段
   - 更新 .claude/project-state.md 的 `phase_history` 记录（含审查结果摘要）
   - 更新 .claude/project-state.md 的 `last_updated` 时间戳
   - **P1→P2、P2→P3**：输出新阶段的入口信息（P2→P3 时提示"进入自动驱动模式"）
   - **P3→P4、P4→P5、P5→P6**：不输出冗余信息，立即开始下一阶段工作
   - **P6 完成**：输出交付摘要报告
6. **审查未通过**：
   - **P1/P2**：列出问题，提供修复建议，等待用户操作
   - **P3-P6（自动驱动）**：自动修复问题 → 重新审查（记录重试次数）
   - 自动修复重试最多 3 次，仍未通过则停下向用户报告

### `back` — 回退到上一阶段
1. 读取当前阶段
2. 如果已是 P0/P1，提示无法继续回退
3. 要求提供回退原因
4. 更新 .claude/project-state.md 的 `current_phase` 为上一阶段
5. 更新 .claude/project-state.md 的 `phase_history` 记录（含回退原因）
6. 更新 .claude/project-state.md 的 `last_updated` 时间戳
7. 输出回退后的阶段信息
8. 注意：回退后上一阶段的审查状态重置，再次推进时需重新审查

---

## 自动驱动模式说明

**P2 设计确认后，P3→P6 自动驱动，无需用户逐阶段操作。**

```
用户确认设计（P2 退出）
  ↓ 自动
P3 编码 → 审查 → 通过 → P4 测试 → 审查 → 通过 → P5 集成 → 审查 → 通过 → P6 交付 → 完成
                 ↑                     ↑                     ↑
           自动修复重试           自动修复重试           自动修复重试
          （最多3次）           （最多3次）           （最多3次）
```

**用户仍可随时介入：**
- 输入 `/phase` 查看当前进度
- 输入 `/review` 手动触发审查
- 输入 `/phase back` 回退
- 输入任何消息暂停自动驱动，Claude 处理后继续

---

## P6 交付摘要报告格式

P6 交付审查通过后，自动输出以下报告：

```
╔══════════════════════════════════════╗
║         交付摘要报告                 ║
╚══════════════════════════════════════╝

📋 PRD 完成情况：
  ✅ R1: {需求描述} — 已实现、已测试
  ✅ R2: {需求描述} — 已实现、已测试
  ...
  完成率：{n}/{n} (100%)

📂 修改文件清单：
  {文件列表}

🧪 测试结果：
  通过：{n} / 失败：0 / 跳过：0

📦 Git 提交：
  {commit hash} {commit message}

📊 开发流程回顾：
  P1→P2→P3→P4→P5→P6 全部通过
  审查重试次数：{n}
  总计修改文件数：{n}
```

---

## 阶段速查表

| 阶段 | 名称 | 核心活动 | 阶段审查 | 推进方式 |
|------|------|---------|---------|---------|
| P0 | 未开始 | 等待任务 | — | — |
| P1 | 需求分析 | 理解需求、整理 PRD | 需求审查 | 用户确认 PRD → 自动审查推进 |
| P2 | 系统设计 | 架构设计、实现计划 | 设计审查 | 用户确认设计 → 自动审查推进 |
| P3 | 编码实现 | 按 PRD 编写代码 | 代码审查 | **自动驱动** |
| P4 | 测试验证 | 按 PRD 编写/执行测试 | 测试审查 | **自动驱动** |
| P5 | 集成审查 | 全局审查、四环追溯 | 集成审查 | **自动驱动** |
| P6 | 部署交付 | Git 提交、交付报告 | 交付审查 | **自动完成** |

---

## 重要提醒

- P1/P2 需要用户确认才能推进，P3-P6 自动驱动无需用户操作
- 审查是每个阶段的退出门禁，自动驱动模式下也不跳过
- 自动驱动中审查失败会自动修复重试，最多 3 次
- 超过 3 次仍失败 → 停下向用户报告，请求指导
- 用户随时可介入，Claude 处理完用户消息后继续自动驱动
- Hooks 在自动驱动模式下仍然有效，确保阶段合规
