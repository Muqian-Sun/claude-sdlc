---
name: review
description: "执行当前阶段审查。检查代码质量、测试覆盖、PRD 符合性。用户说'审查'/'检查'/'review'时自动触发。自动驱动模式下阶段完成后自动执行。"
argument-hint: "[filepath]"
context: fork
allowed-tools:
  - Read
  - Glob
  - Grep
  - Bash
  - Edit
hooks:
  Stop:
    - hooks:
        - type: command
          command: "echo '{\"hookSpecificOutput\":{\"additionalContext\":\"审查完成前确保：(1) 报告已写入 .claude/reviews/ (2) 所有检查项已标注通过/未通过\"}}'"
---

用法：`/review [文件路径]`

参数：$ARGUMENTS

---

## 核心原则

Review 是每个阶段的退出门禁。每个阶段必须检查 PRD 符合性。自动驱动模式下自动执行。

---

## 工具辅助审查

审查 = 工具链输出（客观数据）+ LLM 审查（主观判断）。

1. 自动检测项目类型（见 06-review-tools.md）
2. 检测并安装缺失工具
3. 运行工具收集输出
4. 基于输出 + LLM 分析执行审查清单
5. 生成报告 → 写入 `.claude/reviews/P{n}-review-{时间}.md`

---

## 执行逻辑

1. 读取 project-state.md 的 `current_phase`，选择对应审查清单
2. 有文件路径参数 → 审查指定文件（P3+）；无参数 → 审查全部产出物

---

## P1 需求审查

### 审查清单
- [ ] PRD 编号化（R1, R2...）+ 每条有验收标准
- [ ] 完整（覆盖用户所有需求）+ 一致（无矛盾）+ 无自行添加
- [ ] 范围边界明确 + 可行性 + 影响分析完整
- [ ] 用户已确认 + 已写入 project-state.md

### 输出格式
```
╔══════════════════════════════════════╗
║       P1 需求审查报告                ║
╚══════════════════════════════════════╝

📋 PRD 清单（共 {n} 条需求）：
  R1: {需求描述} — {验收标准}
  ...

🔒 范围排除项：...

✅ / ❌ {逐项审查结果}

⚠️ 发现的问题：
  1. [严重程度] {描述} → {建议}

📊 结论：{通过 / 需补充后通过}
```

---

## P2 设计审查

### 审查清单
- [ ] **最新文档已查阅**（Context7 + WebSearch）
- [ ] **PRD 全覆盖** + **无超出 PRD 的设计**
- [ ] 架构合理（符合最佳实践，无过度设计）+ 与现有架构一致
- [ ] 原型设计完整（如涉及 UI）
- [ ] 接口清晰 + 错误处理已考虑 + 可测试
- [ ] 技术选型有据（引用最新文档）

输出格式参照 P1 模板，增加技术调研、UI/UX 调研、PRD→设计映射等审查项。

---

## P3 代码审查

### 工具执行（审查前必须运行）

**所有 Bash 命令写成单行。** 工具未安装时自动安装（见 06-review-tools.md）。

1. **Lint**：`npx eslint . 2>&1; echo "LINT_EXIT=$?"` — 0 error → ✅
2. **Typecheck**：`npx tsc --noEmit 2>&1; echo "TSC_EXIT=$?"` — 0 error → ✅
3. **Build**：`npm run build 2>&1; echo "BUILD_EXIT=$?"` — 成功 → ✅
4. **依赖审计**：`npm audit 2>&1; echo "AUDIT_EXIT=$?"` — 0 high/critical → ✅

（以上为 Node.js 示例，其他语言见 06-review-tools.md 对照表）

### 审查清单

#### 3.0 最新 API + PRD 符合性
- [ ] 无已废弃 API 调用
- [ ] PRD 全实现（逐条对照）+ 无 PRD 外代码

#### 3.1 设计符合性
- [ ] 与 P2 方案一致

#### 3.2 代码质量 + 安全性 + 可维护性
- [ ] 按 02-coding-standards.md 检查（命名、函数≤50行、嵌套≤3层）
- [ ] 无注入/XSS/硬编码敏感信息
- [ ] 错误处理完善 + 模块职责清晰
- [ ] 无冗余代码 + 导入已清理

### 输出格式
```
╔══════════════════════════════════════╗
║       P3 代码审查报告                ║
╚══════════════════════════════════════╝

📄 审查文件：{文件路径}

🔧 工具链检查：
  Lint：{✅ 0 errors / ❌ N errors}
  Typecheck：{✅ / ❌ / ⬜ 不适用}
  Build：{✅ / ❌}
  依赖审计：{✅ / ⚠️}

0️⃣ 最新 API + PRD：{✅ / ❌}
1️⃣ 设计符合性：{✅ / ⚠️}
2️⃣ 代码质量+安全+可维护：{✅ / ⚠️}

⚠️ 发现的问题：
  1. [严重程度] {描述} → {建议}

📊 结论：{通过 / 需修改后通过}
```

### 未通过处理
- 严重/高 → 当前阶段内修复，重新 `/review`
- 中/低 → 记录 `todo_items`

---

## P4 测试审查

### 测试执行（审查前必须运行）

**核心规则：测试只运行一次，从输出文件分析。整个审查最多 3 次测试。**

1. **运行一次**：`npx vitest run --coverage 2>&1 | tee /tmp/sdlc-test-output.txt; echo "TEST_EXIT=${PIPESTATUS[0]}"`
2. **Read 分析**：读取 `/tmp/sdlc-test-output.txt` 提取通过数/失败数/覆盖率
3. **如有失败**：从文件一次性收集所有错误 → 批量修复 → 再运行一次验证
4. 禁止：重复运行测试、`-t "name"` 单跑、每修一个跑一次

### 审查清单

#### 4.0 PRD 覆盖
- [ ] 逐条 PRD 对照，每条至少一个测试
- [ ] 无 PRD 外测试

#### 4.1 覆盖度 + 质量
- [ ] 正常/错误/边界路径已覆盖 + 关键业务 ≥90%
- [ ] AAA 模式 + 命名清晰 + 独立 + mock 合理

#### 4.2 结果
- [ ] 全部通过 + 行覆盖率 ≥80% + 分支 ≥70%
- [ ] 回归保护 — 已有测试仍通过

输出格式参照 P3 模板，替换为 PRD→测试映射、测试执行结果、覆盖率数据。

### 未通过处理
- 失败 → 从文件批量收集错误，批量修复，再跑一次
- 覆盖率不足 → 补充测试

---

## P5 集成审查

### 审查清单

#### 5.1 全局一致性 + 安全
- [ ] 模块间接口/数据模型/错误处理一致
- [ ] 信任边界 + 权限检查 + 敏感信息传递安全

#### 5.2 性能 + 完整性
- [ ] 无 N+1 / 重复 I/O + 热路径可接受
- [ ] P2 设计已落地 + P3/P4 问题已修复 + 无遗漏 TODO/FIXME

#### 5.3 PRD 四环追溯
- [ ] 逐条追溯：需求→设计→代码文件:行号→测试用例，无断链
- [ ] 无 PRD 外变更

输出格式参照 P3 模板，替换为全局一致性、安全性、PRD 追溯表。

### 未通过处理
- 需求遗漏 → 回 P3 实现 + P4 补测试
- 集成问题 → 回 P3 修复

---

## P6 交付审查

### 审查清单
- [ ] 交付物与 PRD 一致
- [ ] Commit 符合 Conventional Commits + 粒度合理
- [ ] 无敏感信息 + PR 描述完整 + 文档按需更新

输出格式参照 P1 模板，替换为提交审查、文档审查项。

---

## 审查报告持久化

审查完成后写入 `.claude/reviews/P{阶段}-review-{YYYYMMDD-HHmmss}.md`。
