# SDLC 记忆与文档精简优化

## 优化目标

在 v1.8.0 规范精简基础上，进一步优化**要保存的记忆**和**生成的文档**，大幅降低 token 消耗，同时保证恢复能力和质量。

---

## 核心改进

### 1. 记忆存储精简（-60-80% tokens）

#### completed_tasks 归档格式优化

**优化前**（~40 行/任务）：
```yaml
completed_tasks:
  - task: "实现了用户登录功能，包括前端表单、后端验证、状态管理等完整流程"
    prd_summary: "R1: 实现用户登录功能，用户可以通过用户名和密码登录系统..."
    key_decisions:
      - "选择使用 React 18 作为前端框架..."
      - "选择使用 Redux Toolkit..."
      - "选择使用 TypeScript..."
      # ... 多条决策
    files:
      - "src/components/Login.tsx"
      - "src/store/authSlice.ts"
      # ... 所有文件列表
    completed_at: "2025-01-15T10:30:00Z"
```

**优化后**（~6 行/任务）：
```yaml
completed_tasks:
  - task: "用户登录功能"
    prd_summary: "R1:用户登录 R2:密码加密"
    key_decisions: ["React18+TS+Redux"]
    files_count: 5
    completed_at: "2025-01-15"
```

**节省**：40 → 6 行/任务（**-85%**），5 个任务节省 **~170 行（~2500 tokens）**

#### PRD 格式优化

**优化前**（~150-300 行）：
```markdown
# PRD - 用户登录功能

## 背景
本项目需要实现用户登录功能...（长篇背景）

## 需求
### R1 - 用户登录
用户可以通过用户名和密码登录系统。登录成功后跳转到首页...（详细描述）

**验收标准**：
1. 用户输入正确的用户名和密码后...
2. 用户输入错误的用户名或密码...
3. 用户勾选'记住密码'...
4. 连续输入错误密码5次后...

**范围排除**：
- 不包含注册功能
- 不包含忘记密码功能
- 不包含第三方登录

### R2 - 数据展示
...（类似的详细描述）

## 架构设计
### 技术栈
- 前端：React 18
  - 优势：性能更好，代码更简洁
  - 劣势：学习曲线稍陡
- 状态管理：Redux Toolkit
  - 优势：减少样板代码
  ...

### 模块划分
1. 登录模块
   - 组件：LoginForm.tsx
   - 状态：authSlice.ts
   ...

### 数据模型
...（详细的接口定义）
```

**优化后**（~30-50 行）：
```markdown
# PRD - 用户登录功能

## 需求
| ID | 需求 | 验收标准 |
|----|------|----------|
| R1 | 用户登录（用户名/密码） | 正确凭证→首页，错误→提示 |
| R2 | 数据列表展示+分页 | 加载后显示，10条/页 |

## 架构
- **技术栈**: React 18 + TS + Redux Toolkit + Ant Design 5
- **核心模块**: Auth / Dashboard / API Client

## 原型
见 `/tmp/prototype-{timestamp}.html`
```

**节省**：150-300 → 30-50 行（**-80%**，约 2000-3500 tokens）

#### phase_history 压缩

**优化前**（可能积累 20+ 条）：
```yaml
phase_history:
  - "P0→P1 2024-12-01 09:00"
  - "P1→P2 2024-12-01 10:00"
  - "P2→P3 2024-12-01 14:00"
  - "P3→P2 2024-12-01 15:00 测试失败"
  - "P2→P3 2024-12-01 15:30"
  - "P3→P4 2024-12-01 16:00"
  - "P4→P2 2024-12-01 16:30 lint错误"
  - "P2→P3 2024-12-01 17:00"
  - "P3→P4 2024-12-01 17:15"
  - "P4→P5 2024-12-01 17:30"
  # ... 多个任务累积
```

**优化后**（保留最近 5 条）：
```yaml
phase_history:
  # 历史记录已压缩，保留最近5条
  - "P1→P2 2025-02-08 10:00"
  - "P2→P3 2025-02-08 14:00"
  - "P3→P4 2025-02-08 16:00"
  - "P4→P5 2025-02-08 17:00"
  - "P0→P1 2025-02-09 09:00"
```

**节省**：20+ → 5 条（**-75%**，约 200-300 tokens）

---

### 2. 文档生成精简（已在 v1.8.0 实现）

| 文档类型 | 优化前 | 优化后 | 节省 |
|---------|--------|--------|------|
| P4 审查报告 | ~20 行 | ~10 行 | -50% |
| P5 交付摘要 | ~12 行 | ~5 行 | -58% |
| 状态报告 | ~15 行 | ~8 行 | -47% |

---

### 3. 自动归档机制（新增）

**功能**：`/archive` 命令 + 自动触发

**归档规则**：
- completed_tasks ≥ 5 个 → 归档最旧 2 个到 `.claude/archive/tasks-{year}.md`
- phase_history ≥ 10 条 → 压缩到 5 条
- architecture_decisions ≥ 8 条 → 精简到 5 条

**归档格式**（极简）：
```markdown
# 2025 已完成任务归档

- 2025-01-15: 用户登录功能 (5文件)
- 2025-01-20: 数据展示优化 (3文件)
```

**触发时机**：
- 自动：P5 完成后提示，Compaction 前自动压缩
- 手动：`/archive` 命令

---

## Token 消耗对比

### 典型项目场景（5 个已完成任务）

| 组成部分 | 优化前 | 优化后 | 节省 |
|---------|--------|--------|------|
| **规范本身** | 801 行 | 701 行 | -100 行 |
| **completed_tasks** (5个) | ~200 行 | ~30 行 | -170 行 |
| **PRD** (当前任务) | ~200 行 | ~40 行 | -160 行 |
| **phase_history** | ~20 行 | ~5 行 | -15 行 |
| **审查报告** (1次) | ~20 行 | ~10 行 | -10 行 |
| **交付摘要** (1次) | ~12 行 | ~5 行 | -7 行 |
| **状态查询** (3次) | ~45 行 | ~24 行 | -21 行 |
| **总计** | **~1298 行** | **~815 行** | **-483 行** |

**Token 节省**：约 **7000-8000 tokens**（按每行 15 tokens 估算）

### 长期项目场景（20 个已完成任务）

| 组成部分 | 优化前 | 优化后（归档） | 节省 |
|---------|--------|--------------|------|
| completed_tasks (20个) | ~800 行 | ~30 行（保留3个）+ 归档 | -770 行 |
| phase_history | ~80 行 | ~5 行 | -75 行 |
| **额外节省** | | | **-845 行** |

**Token 节省**：约 **12000-13000 tokens**

---

## 新增文件

### 1. `.claude/rules/09-memory-management.md`（新增，173行）

**内容**：
- project-state.md 精简规则
- PRD 生成格式（精简版）
- completed_tasks 归档格式
- phase_history 压缩规则
- compaction 保护精简
- 自动归档机制
- 文档生成通用规则（长度限制、一句话原则）
- 示例对比（冗余版 vs 精简版）

### 2. `.claude/skills/archive/SKILL.md`（新增，149行）

**功能**：
- 归档 completed_tasks（≥5个时）
- 压缩 phase_history（≥10条时）
- 精简 architecture_decisions（≥8条时）
- 生成归档报告（节省空间统计）

**用法**：
- 自动触发：P5 完成后提示
- 手动触发：`/archive` 命令

---

## 修改文件清单

### 1. `template/.claude/project-state.md`

**改动**：
- ✅ 添加精简格式说明和示例
- ✅ 字段注释添加长度限制（≤30字、≤50字等）
- ✅ 更新 compaction 保护规则（优先级排序）
- ✅ 添加自动清理触发条件

**关键变更**：
```yaml
# 优化前
completed_tasks: []  # 已完成任务归档（task/prd_summary/key_decisions/files/completed_at）

# 优化后
completed_tasks: []  # 已完成任务归档（精简格式，见 09-memory-management.md）
  # - task: "一句话描述"
  #   prd_summary: "R1:需求1 R2:需求2"  # ≤50字
  #   key_decisions: ["技术栈", "架构决策"]  # ≤3条
  #   files_count: 5  # 不列举文件名
  #   completed_at: "2025-01-15"
  # 自动清理：≥5个时归档最旧2个到 .claude/archive/
```

### 2. `template/.claude/rules/01-lifecycle-phases.md`

**改动**：
- ✅ PRD 确认部分添加精简格式要求
- ✅ 添加 PRD 长度限制（≤150行）
- ✅ 强调表格格式、一句话需求
- ✅ 删除范围排除项要求（改为可选）

### 3. `template/CLAUDE.md`

**改动**：
- ✅ 添加 `/archive` 到可用命令列表
- ✅ 执行规范添加记忆精简要求
- ✅ 引用 09-memory-management.md
- ✅ 添加长度限制说明

---

## 精简原则总结

### 最小必要原则
只保存恢复工作所需的最小信息集：
- ✅ 当前任务的完整状态
- ✅ 最近 3 个已完成任务（摘要）
- ✅ 关键架构决策（≤5条）
- ❌ 详细历史记录（归档）
- ❌ 所有文件列表（只记数量）
- ❌ 冗余描述（一句话足够）

### 一句话原则
能用一句话说清楚的不用两句：
- 需求描述：≤30字
- 任务描述：≤30字
- PRD 摘要：≤50字
- 验收标准：1条，可测试

### 表格优先
结构化信息用表格，不用段落：
- PRD 需求表
- 架构决策列表
- 审查结果表

### 自动清理
- completed_tasks ≥ 5 → 归档
- phase_history ≥ 10 → 压缩
- architecture_decisions ≥ 8 → 精简

---

## 质量保证

### ✅ 恢复能力不减
- 当前任务状态完整（PRD + 阶段 + 文件）
- 关键上下文保留（key_context ≤50字）
- 最近任务历史可追溯（3个）
- Compaction 恢复机制完整

### ✅ 开发效率不降
- PRD 精简但完整（需求 + 验收 + 架构）
- 审查清单不变
- 禁止行为不变
- 工具限制不变

### ✅ 记忆不丢失
- 历史任务归档到 `.claude/archive/`（极简格式）
- 归档前自动备份 `project-state.md`
- 归档文件只追加，不删除
- Git 历史保留完整代码和文档

---

## 使用示例

### 场景 1：P1 阶段生成 PRD

```markdown
# PRD - 用户管理功能

## 需求
| ID | 需求 | 验收标准 |
|----|------|----------|
| R1 | 用户列表（分页/搜索/筛选） | 加载显示，搜索实时，筛选生效 |
| R2 | 用户编辑（姓名/邮箱/角色） | 保存成功提示，表单验证 |
| R3 | 用户删除（软删除+确认） | 确认后删除，列表刷新 |

## 架构
- **技术栈**: React 18 + TS + TanStack Table + React Hook Form
- **核心模块**: UserList / UserForm / UserAPI

## 原型
见 `/tmp/prototype-20250208.html`
```

**总长度**：~30 行（vs 优化前 ~200 行）

### 场景 2：P5 完成，归档任务

```yaml
# 归档前
completed_tasks:
  - task: "用户登录"
    prd_summary: "R1:登录 R2:加密"
    key_decisions: ["React18", "JWT"]
    files_count: 5
    completed_at: "2024-11-15"
  - task: "数据展示"
    # ... 4 个任务
  - task: "用户管理"
    prd_summary: "R1:列表 R2:编辑 R3:删除"
    key_decisions: ["TanStack Table"]
    files_count: 8
    completed_at: "2025-02-08"

# 归档后（保留最近3个）
completed_tasks:
  - task: "导出功能"
    prd_summary: "R1:Excel R2:PDF"
    key_decisions: ["xlsx库"]
    files_count: 6
    completed_at: "2025-01-20"
  - task: "权限管理"
    prd_summary: "R1:角色 R2:菜单"
    key_decisions: ["RBAC"]
    files_count: 7
    completed_at: "2025-02-01"
  - task: "用户管理"
    prd_summary: "R1:列表 R2:编辑 R3:删除"
    key_decisions: ["TanStack Table"]
    files_count: 8
    completed_at: "2025-02-08"
```

**归档文件**（`.claude/archive/tasks-2024.md`）：
```markdown
# 2024 已完成任务归档

- 2024-11-15: 用户登录 (5文件)
- 2024-12-01: 数据展示 (4文件)
```

**节省**：~150 行 → ~40 行（**-73%**）

### 场景 3：Compaction 恢复

**压缩前保存**（优化后 ~200 行）：
- current_phase + task_description
- prd（精简格式，~40行）
- modified_files（仅路径）
- key_context（≤50字）
- completed_tasks（最近3个，~30行）
- global_architecture（≤5条）

**压缩前删除**：
- phase_history（保留最近5条）
- todo_items（可从prd重建）
- 超过3个的 completed_tasks（已归档）

---

## 验证清单

### P1 阶段（PRD 生成）
- [ ] PRD 总长度 ≤ 150 行
- [ ] 每条需求描述 ≤ 30 字
- [ ] 架构决策 ≤ 5 条
- [ ] 使用表格格式
- [ ] 无范围排除项（或 ≤ 3 条且必要）

### P5 阶段（任务归档）
- [ ] prd_summary ≤ 50 字
- [ ] key_decisions ≤ 3 条
- [ ] 记录 files_count，不列举文件名
- [ ] completed_tasks ≥ 5 时触发归档提示

### 定期维护（/archive）
- [ ] 每完成 5 个任务执行一次归档
- [ ] Compaction 前检查 phase_history（≥10条压缩）
- [ ] 检查 project-state.md 总长度（建议 ≤300行）

---

## 预期效果

### Token 消耗优化（累积）

| 项目阶段 | 优化前 | 优化后 | 节省 |
|---------|--------|--------|------|
| **初始（1个任务）** | ~1000 行 | ~800 行 | -20% |
| **短期（5个任务）** | ~1300 行 | ~815 行 | -37% |
| **长期（20个任务）** | ~2500 行 | ~850 行 | -66% |

**经济效益**：
- 短期项目：节省 ~7000 tokens/项目
- 长期项目：节省 ~25000 tokens/项目
- Claude Code 按 token 计费，直接降低使用成本

### 用户体验改善

✅ 上下文加载更快（内容更少）
✅ PRD 更易读（表格化、一句话）
✅ 历史记忆不丢失（归档机制）
✅ 自动化管理（无需手动清理）
✅ 恢复能力不减（关键信息完整）

---

## 下一步

1. 测试完整流程（P1→P5 + 归档）
2. 验证 Compaction 恢复
3. 优化归档触发时机
4. 考虑添加归档统计（节省 tokens 数）
